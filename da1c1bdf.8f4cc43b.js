(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{201:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return u}));var o=n(2),a=n(11),i=(n(0),n(206)),r=n(208),l={title:"Dive Deeper"},c={id:"datasource-dive-deeper",title:"Dive Deeper",description:"CKComponentDataSource in details",source:"@site/docs/datasource-dive-deeper.md",permalink:"/docs/datasource-dive-deeper",sidebar:"docs",previous:{title:"Gotchas",permalink:"/docs/datasource-gotchas"},next:{title:"Never Subclass Components",permalink:"/docs/never-subclass-components"}},s=[{value:"CKComponentDataSource in details",id:"ckcomponentdatasource-in-details",children:[]},{value:"Use CKComponentDataSource directly",id:"use-ckcomponentdatasource-directly",children:[{value:"Example: Use it in your ViewController to power a UITableView",id:"example-use-it-in-your-viewcontroller-to-power-a-uitableview",children:[]}]}],p={rightToc:s};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(o.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"ckcomponentdatasource-in-details"},"CKComponentDataSource in details"),Object(i.b)("p",null,"Here is what happens behind the scenes where a changeset is enqueued:"),Object(i.b)("img",{src:Object(r.a)("assets/datasource.png"),alt:"Overwiew of the datasource",width:"592",height:"654"}),Object(i.b)("div",{class:"note"},Object(i.b)("p",null,'We will use "list view" to refer to either a ',Object(i.b)("inlineCode",{parentName:"p"},"UICollectionView")," or a ",Object(i.b)("inlineCode",{parentName:"p"},"UITableView"))),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"A changeset is enqueued in ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentDataSource")," (maybe proxied by CKCollectionViewDataSource or another adapter), the CKComponentDataSource updates its internal input state."),Object(i.b)("li",{parentName:"ol"},"Changes are asynchronously enqueued in the preparation queue and processed in the background. Each model in the changeset will get it's component tree generated and laid out by calling the ",Object(i.b)("inlineCode",{parentName:"li"},"componentForModel:")," function on the componentProvider."),Object(i.b)("li",{parentName:"ol"},"Once the components are computed, the output changeset is processed:",Object(i.b)("ol",{parentName:"li"},Object(i.b)("li",{parentName:"ol"},"The output changeset is applied to the internal output state of ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentDataSource"),"."),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"CKComponentDataSource")," messages its delegate with the changeset."),Object(i.b)("li",{parentName:"ol"},"This changeset triggers a batch update of the list view it has a reference to. This is the way ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentCollectionViewDataSource")," is set up. When the output changeset is received, it will call ",Object(i.b)("inlineCode",{parentName:"li"},"- performBatchUpdates:completion:")," on the collection view with the right mutation calls."))),Object(i.b)("li",{parentName:"ol"},"The list view will then request updated content, either immediately if some updated content is visible or later when the updated content will become visible while scrolling :",Object(i.b)("ol",{parentName:"li"},Object(i.b)("li",{parentName:"ol"},"Either ",Object(i.b)("inlineCode",{parentName:"li"},"-cellForRowAtIndexPath:")," or ",Object(i.b)("inlineCode",{parentName:"li"},"cellForItemAtIndexPath:")," will be called by the list view on its datasource."),Object(i.b)("li",{parentName:"ol"},"The datasource calls the ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentDataSource")," to get an handle (a ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentLifeCycleManager")," in this case) on the most up to date component tree."),Object(i.b)("li",{parentName:"ol"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"CKComponentLifeCycleManager")," is then returned to the list view datasource that will mount the component tree on the cell."),Object(i.b)("li",{parentName:"ol"},"Which is then returned to the list view that will display it.")))),Object(i.b)("h2",{id:"use-ckcomponentdatasource-directly"},"Use CKComponentDataSource directly"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"CKCollectionViewDataSource")," should be sufficient for most uses of ComponentKit with a collection view. If you need more control or want to use a components datasource with a different type of views you can still use ",Object(i.b)("inlineCode",{parentName:"p"},"CKComponentDataSource")," directly."),Object(i.b)("p",null,"Here is an example of usage of ",Object(i.b)("inlineCode",{parentName:"p"},"CKComponentDataSource")," directly with a UIViewController. You can also go inspect the source code of ",Object(i.b)("inlineCode",{parentName:"p"},"CKCollectionViewDataSource")," and see how it's done."),Object(i.b)("h3",{id:"example-use-it-in-your-viewcontroller-to-power-a-uitableview"},"Example: Use it in your ViewController to power a UITableView"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ComponentsTableViewController.h")),Object(i.b)("pre",null,Object(i.b)("code",Object(o.a)({parentName:"pre"},{className:"language-objectivec"}),'/* This file provided by Facebook is for non-commercial testing and evaluation\n * purposes only.  Facebook reserves all rights not expressly granted.\n *\n * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n * FACEBOOK BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN\n * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n#import <UIKit/UIKit.h>\n\n@interface ComponentsTableViewController : UIViewController\n\n@end\n')),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ComponentTableViewController.mm")),Object(i.b)("pre",null,Object(i.b)("code",Object(o.a)({parentName:"pre"},{className:"language-objectivec"}),'/* This file provided by Facebook is for non-commercial testing and evaluation\n * purposes only.  Facebook reserves all rights not expressly granted.\n *\n * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n * FACEBOOK BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN\n * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n#import "ComponentsTableViewController.h"\n\n#import <ComponentKit/CKComponentProvider.h>\n#import <ComponentKit/CKComponentDataSource.h>\n#import <ComponentKit/CKComponentDataSourceOutputItem.h>\n#import <ComponentKit/CKComponentConstantDecider.h>\n#import <ComponentKit/CKDimension.h>\n#import <ComponentKit/CKTextComponent.h>\n\nstatic NSString *const kReuseIdentifier = @"com.component_kit.table_view_data_source.cell";\n\n@interface ComponentsTableViewController () <\nCKComponentProvider,\nCKComponentDataSourceDelegate,\nUITableViewDataSource,\nUITableViewDelegate\n>\n\n@end\n\n@implementation ComponentsTableViewController {\n  UITableView *_tableView;\n  CKComponentDataSource *_componentDataSource;\n  CKSizeRange _constrainedSize;\n}\n\n- (void)loadView\n{\n  _tableView = [[UITableView alloc] init];\n  [self setView:_tableView];\n}\n\n- (void)viewDidLoad\n{\n  [super viewDidLoad];\n  [_tableView registerClass:[UITableViewCell class] forCellReuseIdentifier:kReuseIdentifier];\n  _tableView.dataSource = self;\n  _tableView.delegate = self;\n  _componentDataSource = [[CKComponentDataSource alloc] initWithComponentProvider:[self class]\n                                                                          context:nil\n                                                                          decider:[[CKComponentConstantDecider alloc] initWithEnabled:@YES]];\n  _componentDataSource.delegate = self;\n}\n\n- (void)viewDidAppear:(BOOL)animated\n{\n  [super viewDidAppear:animated];\n  // Insert the initial section and two rows in the componentDataSource\n  CKArrayControllerSections sections;\n  CKArrayControllerInputItems items;\n  sections.insert(0);\n  items.insert({0,0}, @"Hello");\n  items.insert({0,1}, @"World !");\n  CGFloat tableViewWidth = _tableView.bounds.size.width;\n  [_componentDataSource enqueueChangeset:{sections, items}\n                         constrainedSize:{{tableViewWidth, 0},{tableViewWidth, INFINITY}}];\n}\n\n#pragma mark - UITableViewDatasource\n\n- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath\n{\n  // Grab the output item\n  CKComponentDataSourceOutputItem *outputItem = [_componentDataSource objectAtIndexPath:indexPath];\n  // Dequeue a table view cell\n  UITableViewCell *cell = [_tableView dequeueReusableCellWithIdentifier:kReuseIdentifier];\n  // Get the lifecycle manager\n  CKComponentLifecycleManager *lifecycleManager = [outputItem lifecycleManager];\n  // Mount the corresponding component tree in the cell container view\n  [lifecycleManager attachToView:cell.contentView];\n  return cell;\n}\n\n#pragma mark - UITableViewDelegate\n\n- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath\n{\n  // Query the datasource for the height of the corresponding component\n  return [[[_componentDataSource objectAtIndexPath:indexPath] lifecycleManager] size].height;\n}\n\n- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView\n{\n  return [_componentDataSource numberOfSections];\n}\n\n- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section\n{\n  return [_componentDataSource numberOfObjectsInSection:section];\n}\n\n#pragma mark - CKComponentDatasourceDelegate\n\n- (void)componentDataSource:(CKComponentDataSource *)componentDataSource\n          hasChangesOfTypes:(CKComponentDataSourceChangeType)changeTypes\n        changesetApplicator:(ck_changeset_applicator_t)changesetApplicator\n{\n  // Once the datasource has computed the components, perform a batch update\n  // on the tableView to insert/delete/update rows and insert/delete sections.\n  [_tableView beginUpdates];\n  const auto &changeset = changesetApplicator();\n  applyChangesetToTableView(changeset, _tableView);\n  [_tableView endUpdates];\n}\n\nstatic void applyChangesetToTableView(const CKArrayControllerOutputChangeset &changeset, UITableView *tableView)\n{\n  CKArrayControllerSections::Enumerator sectionsEnumerator = ^(NSIndexSet *sectionIndexes, CKArrayControllerChangeType type, BOOL *stop) {\n    if (type == CKArrayControllerChangeTypeDelete) {\n      [tableView deleteSections:sectionIndexes withRowAnimation:UITableViewRowAnimationFade];\n    }\n    if (type == CKArrayControllerChangeTypeInsert) {\n      [tableView insertSections:sectionIndexes withRowAnimation:UITableViewRowAnimationFade];\n    }\n  };\n\n  CKArrayControllerOutputItems::Enumerator itemEnumerator =\n  ^(const CKArrayControllerOutputChange &change, CKArrayControllerChangeType type, BOOL *stop) {\n    NSIndexPath *indexPath = change.destinationIndexPath.toNSIndexPath();\n    if (type == CKArrayControllerChangeTypeDelete) {\n      [tableView deleteRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationFade];\n    }\n    if (type == CKArrayControllerChangeTypeInsert) {\n      [tableView insertRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationFade];\n    }\n    if (type == CKArrayControllerChangeTypeUpdate) {\n      [tableView reloadRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationFade];\n    }\n  };\n\n  // Enumerate over the changeset and for each type of change perform the corresponding changes\n  // on the table view\n  changeset.enumerate(sectionsEnumerator, itemEnumerator);\n}\n\n- (void)componentDataSource:(CKComponentDataSource *)componentDataSource\n     didChangeSizeForObject:(CKComponentDataSourceOutputItem *)object\n                atIndexPath:(NSIndexPath *)indexPath\n                  animation:(const CKComponentBoundsAnimation &)animation\n{\n  [_tableView beginUpdates];\n  [_tableView endUpdates];\n}\n\n#pragma mark - CKComponentProvider\n\n+ (CKComponent *)componentForModel:(NSString *)model context:(id<NSObject>)context\n{\n  return\n   [CKTextComponent\n    newWithTextAttributes:{\n      .attributedString =\n      [[NSAttributedString alloc]\n       initWithString:model\n       attributes:@{NSFontAttributeName: [UIFont fontWithName:@"AmericanTypewriter" size:26]}]\n    }\n    viewAttributes:{{@selector(setBackgroundColor:), [UIColor clearColor]}}\n    accessibilityContext:{}];\n}\n\n@end\n')))}u.isMDXComponent=!0},206:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var o=n(0),a=n.n(o);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),p=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l({},t,{},e)),n},u=function(e){var t=p(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=Object(o.forwardRef)((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,r=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),u=p(n),m=o,b=u["".concat(r,".").concat(m)]||u[m]||d[m]||i;return n?a.a.createElement(b,l({ref:t},s,{components:n})):a.a.createElement(b,l({ref:t},s))}));function b(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var s=2;s<i;s++)r[s]=n[s];return a.a.createElement.apply(null,r)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},207:function(e,t,n){"use strict";var o=n(0),a=n(59);t.a=function(){return Object(o.useContext)(a.a)}},208:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));n(209);var o=n(207);function a(e){var t=(Object(o.a)().siteConfig||{}).baseUrl,n=void 0===t?"/":t;if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}},209:function(e,t,n){"use strict";var o=n(8),a=n(10),i=n(210),r="".startsWith;o(o.P+o.F*n(211)("startsWith"),"String",{startsWith:function(e){var t=i(this,e,"startsWith"),n=a(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),o=String(e);return r?r.call(t,o,n):t.slice(n,n+o.length)===o}})},210:function(e,t,n){var o=n(86),a=n(30);e.exports=function(e,t,n){if(o(t))throw TypeError("String#"+n+" doesn't accept regex!");return String(a(e))}},211:function(e,t,n){var o=n(3)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[o]=!1,!"/./"[e](t)}catch(a){}}return!0}}}]);