<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.56">
<link rel="search" type="application/opensearchdescription+xml" title="ComponentKit" href="/opensearch.xml"><title data-react-helmet="true">UI Context | ComponentKit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="UI Context | ComponentKit"><meta data-react-helmet="true" name="description" content="When building a new surface we think in function of the model and context that in input to the render method invoked  over time due to a user interaction or system event."><meta data-react-helmet="true" property="og:description" content="When building a new surface we think in function of the model and context that in input to the render method invoked  over time due to a user interaction or system event."><meta data-react-helmet="true" property="og:url" content="https://componentkit.org/docs/infrastructure/fb/uicontext"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://componentkit.org/docs/infrastructure/fb/uicontext"><link rel="stylesheet" href="/styles.2c8823ce.css">
<link rel="preload" href="/styles.4c40f132.js" as="script">
<link rel="preload" href="/runtime~main.970be1ec.js" as="script">
<link rel="preload" href="/main.f660b34f.js" as="script">
<link rel="preload" href="/1.0674d3fc.js" as="script">
<link rel="preload" href="/2.62d007f0.js" as="script">
<link rel="preload" href="/1be78505.72e2fb40.js" as="script">
<link rel="preload" href="/70.b7099cfa.js" as="script">
<link rel="preload" href="/20ac7829.71c801c2.js" as="script">
<link rel="preload" href="/9ec529c8.14198a0c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/ck_logo.png" alt="ComponentKit Logo"><strong class="navbar__title">ComponentKit</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/docs/infrastructure/component-hosting-view">Infrastructure</a><a href="https://www.componentkit.org/appledoc/html/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a><a href="https://github.com/facebook/componentkit" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><div class="searchWrapper_-F3-"><span aria-label="expand searchbar" role="button" class="searchIconButton_1Dnz" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_2eto"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/ck_logo.png" alt="ComponentKit Logo"><strong class="navbar__title">ComponentKit</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/infrastructure/component-hosting-view">Infrastructure</a></li><li class="menu__list-item"><a href="https://www.componentkit.org/appledoc/html/index.html" target="_blank" rel="noopener noreferrer" class="menu__link">API</a></li><li class="menu__list-item"><a href="https://github.com/facebook/componentkit" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">UI Context</h1></header><div class="markdown"><p>When building a new surface we think in function of the model and context that in input to the render method invoked  over time due to a user interaction or system event.</p><p>Although this is how <a href="/docs/animations-general-principles">react-inspired frameworks recommend to write UI</a>, there are certain events, that rather than belonging solely to our data dependency, are actually a representation of a change affecting the whole hosting <em>environment</em> and <strong>not just</strong> the surface we are building.</p><p>The <strong>UIContext</strong> is responsible to give you access (and override when necessary) any features that belongs to the current environment such as: theming, trait collection, accessibility status and so on.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="read-from-the-ui-component-context"></a>Read from the UI Component Context<a aria-hidden="true" tabindex="-1" class="hash-link" href="#read-from-the-ui-component-context" title="Direct link to heading">#</a></h2><p>As consumer of this API you are mostly interested to read the <strong>UIContext</strong> and not directly write onto it. Making sure the <em>UIContext</em> stays up to date is guaranteed by the infrastructure as long as your surface depends on infra view controllers (e.g. <em>FBComponentViewController</em>, <em>FBSurfaceViewController</em>).</p><p>For any relevant environment context update a new value is pushed onto the component/sections hierarchy before it gets completely reflow.</p><p>To access the context you can invoke it directly from your render function as following</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="component-spec"></a>Component Spec<a aria-hidden="true" tabindex="-1" class="hash-link" href="#component-spec" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-objc codeBlock_1wn8" style="color:#393A34"><div class="token-line" style="color:#393A34"><span class="token plain">#import &lt;FBUIComponentContext/FBUIComponentContext.h&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">namespace MyAwesomeComponentSpec {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">CK_RENDER</span></div><div class="token-line" style="color:#393A34"><span class="token plain">CKComponent *render(const Props &amp;props){</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  auto const traitCollection = CK::UIContext::getTraitCollection();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  auto const theme = CK::UIContext::getTheme();</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  return FBLabelTextComponent({</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    .string = DescriptionForTraitCollection(traitCollection),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    .color = FDS::UsageColor(FDS::UsageColor::PrimaryText, theme)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  });</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></pre></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="components-api"></a>Components API<a aria-hidden="true" tabindex="-1" class="hash-link" href="#components-api" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-objc codeBlock_1wn8" style="color:#393A34"><div class="token-line" style="color:#393A34"><span class="token plain">#import &lt;FBUIComponentContext/FBUIComponentContext.h&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">@implementation MyAwesomeComponent {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  + (instancetype)new</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    auto const traitCollection = CK::UIContext::getTraitCollection();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    auto const theme = CK::UIContext::getTheme();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    return [super newWithComponent: FBLabelTextComponent({</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      .string = DescriptionForTraitCollection(traitCollection),</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      .color = FDS::UsageColor(FDS::UsageColor::PrimaryText, theme)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    });]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></pre></div><div class="note"><p>In case you can&#x27;t rely on <a href="https://developer.apple.com/library/archive/featuredarticles/ViewControllerPGforiPhoneOS/ImplementingaContainerViewController.html">view controller containment API</a> to build your surface, you&#x27;ll have to manually guarantee the right UIContext instance is available accordingly to the received events.</p></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="write-onto-the-ui-context"></a>Write onto the UI context<a aria-hidden="true" tabindex="-1" class="hash-link" href="#write-onto-the-ui-context" title="Direct link to heading">#</a></h2><p>In case you need to override a received UIContext instance or you need to build your own integration with the UIContext, the API also supports a writer access that allows you to override the available instance that is available to the current component hierarchy to build.</p><p>Every UIContext instance lives in the scope of a component hierarchy generation. It should be generated before initializing the very first component of our hierarchy and it will automatically disappear once the hierarchy has been built (all the components have been processed their initializer/render function).</p><p>As maintainer of the UIContext for your surface you are responsible to properly react to all changes that are delivered by the system and that are relevant to what we store in the UIContext. A change in the current trait collection for instance <strong>must</strong> trigger a new component hierarchy generation (a.k.a. trigger state update or context update) by making sure the UIContext is later pushed before generation:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-objc codeBlock_1wn8" style="color:#393A34"><div class="token-line" style="color:#393A34"><span class="token plain">// Callback delivered by UIKit every time **anything** in the trait collection has changed</span></div><div class="token-line" style="color:#393A34"><span class="token plain">- (void)traitCollectionDidChange:(UITraitCollection *)previousTraitCollection</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [super traitCollectionDidChange:previousTraitCollection];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  auto const uiComponentContext = [FBUIComponentContext</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    newWithTraitCollection:self.traitCollection</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                                     theme:self.fb_theme</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                       accessibilityStatus:_accessibilityStatus];</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Update the hosting view current model that will be passed to the component generator function.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [_hostingView updateModel:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   [[MyAwesomeModel alloc]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    initWithUIComponentContext:uiComponentContext</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    mode:CKUpdateModeAsynchronous];</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Reflow the new UIContext  The consequential update model and reload will be batched together by the infra.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [_hostingView reloadWithMode:CKUpdateModeAsynchronous];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">#pragma mark - CKComponentProvider</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">static auto componentForModel:(id&lt;NSObject&gt; model, id&lt;NSObject&gt; context) -&gt; CKComponent *</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  auto const model = CK::objCForceCast&lt;MyAwesomeModel&gt;(model);</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Push the UI component context prior to component generation</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  CK::UIContext u(model.uiComponentContext);</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  // Build and return your component hierarchy</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  return ...;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="accessibility-update"></a>Accessibility Update<a aria-hidden="true" tabindex="-1" class="hash-link" href="#accessibility-update" title="Direct link to heading">#</a></h2><p>In order to update the <code>UIContext</code> to be in sync with accessibility status the best way is to have your UIViewController subclass conforms to <code>FBAccessibilityInvalidationEventsListener</code> and update the context in one of the listener callbacks.</p><div class="note-important"><p>Because of an issue (or a feature) with Apple Accessibility notifications the callbacks can be triggered multiple times for the same event, so adding a check before modifying the <code>UIContext</code> can prevent multiple reflows.</p></div><p><strong>Example:</strong></p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-objc codeBlock_1wn8" style="color:#393A34"><div class="token-line" style="color:#393A34"><span class="token plain">@interface MYAwesomeViewController () &lt;FBAccessibilityInvalidationEventsListener&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">- (void)viewDidLoad {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [super viewDidLoad];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  FBAddAccessibilityInvalidationEventsListener(self);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  ...</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">#pragma mark - Accessibility Update</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">- (void)didReceiveAccessibilityInvalidation</span></div><div class="token-line" style="color:#393A34"><span class="token plain">{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  if (_accessibilityEnabled != CK::Component::Accessibility::IsAccessibilityEnabled()) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    _accessibilityEnabled = CK::Component::Accessibility::IsAccessibilityEnabled();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    auto const uiComponentContext = [FBUIComponentContext</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    newWithTraitCollection:self.traitCollection</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                                     theme:self.fb_theme</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                       accessibilityStatus:_accessibilityStatus];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // Update the hosting view current model that will be passed to the component generator function.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [_hostingView updateModel:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     [[MyAwesomeModel alloc]</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      initWithUIComponentContext:uiComponentContext</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      mode:CKUpdateModeAsynchronous];</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    [_hostingView updateAccessibilityStatus:_accessibilityEnabled mode:CKUpdateModeSynchronous];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></pre></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="plug-and-play"></a>Plug and play<a aria-hidden="true" tabindex="-1" class="hash-link" href="#plug-and-play" title="Direct link to heading">#</a></h2><p>You can quickly play with the context API through our Playground app:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-shell codeBlock_1wn8" style="color:#393A34"><div class="token-line" style="color:#393A34"><span class="token plain">$ arc playground UIContextShowcase</span></div></pre></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#read-from-the-ui-component-context" class="table-of-contents__link">Read from the UI Component Context</a><ul><li><a href="#component-spec" class="table-of-contents__link">Component Spec</a></li><li><a href="#components-api" class="table-of-contents__link">Components API</a></li></ul></li><li><a href="#write-onto-the-ui-context" class="table-of-contents__link">Write onto the UI context</a></li><li><a href="#accessibility-update" class="table-of-contents__link">Accessibility Update</a></li><li><a href="#plug-and-play" class="table-of-contents__link">Plug and play</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Facebook Open Source Logo" src="https://docusaurus.io/img/oss_logo.png"></div><div>Copyright © 2020 Facebook, Inc.</div></div></div></footer></div>
<script src="/styles.4c40f132.js"></script>
<script src="/runtime~main.970be1ec.js"></script>
<script src="/main.f660b34f.js"></script>
<script src="/1.0674d3fc.js"></script>
<script src="/2.62d007f0.js"></script>
<script src="/1be78505.72e2fb40.js"></script>
<script src="/70.b7099cfa.js"></script>
<script src="/20ac7829.71c801c2.js"></script>
<script src="/9ec529c8.14198a0c.js"></script>
</body>
</html>